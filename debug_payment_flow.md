# üîç –û—Ç–ª–∞–¥–∫–∞ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ Stripe

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –æ—Å—Ç–∞–µ—Ç—Å—è "Unpaid" –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤ Stripe

## üìã –®–∞–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è stripe_session_id
```bash
cd shop
python check_order_status.py [order_id]
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Stripe Session ID: cs_test_... (–Ω–µ "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook –ª–æ–∫–∞–ª—å–Ω–æ
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ó–∞–ø—É—Å–∫ webhook listener
cd shop
stripe listen --forward-to localhost:8000/payment/webhook/

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Django —Å–µ—Ä–≤–µ—Ä
cd shop
python manage.py runserver

# –¢–µ—Ä–º–∏–Ω–∞–ª 3: –¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞
# –í –±—Ä–∞—É–∑–µ—Ä–µ –æ–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Django:**
```
üîÑ STRIPE WEBHOOK: Received webhook request
‚úÖ STRIPE WEBHOOK: Event verified: checkout.session.completed
üí≥ STRIPE WEBHOOK: Processing payment for session cs_test_...
üì¶ STRIPE WEBHOOK: Found order X, current paid status: False
‚úÖ STRIPE WEBHOOK: Order X marked as paid
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞
```bash
cd shop
python test_mark_paid.py [order_id]
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ API –æ—Ç–≤–µ—Ç: {'message': 'Order marked as paid', 'order': {...}}
üì¶ –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞: paid=True
üéâ –£—Å–ø–µ—Ö! –ó–∞–∫–∞–∑ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ React –ª–æ–≥–æ–≤
–í –±—Ä–∞—É–∑–µ—Ä–µ F12 ‚Üí Console –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ:
```
üîÑ REACT: Calling markPaid API for order: X
‚úÖ REACT: Order status updated via API: {...}
```

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### ‚ùå Stripe Session ID –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ `create_checkout_session`
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Django –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
```
‚úÖ DEBUG: Stripe session created: cs_test_...
üíæ DEBUG: Session ID saved to order X
```

### ‚ùå Webhook –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞:** `stripe listen` –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ webhook secret –Ω–µ–≤–µ—Ä–Ω—ã–π
**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `stripe listen` –∑–∞–ø—É—â–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `STRIPE_WEBHOOK_SECRET` –≤ `.env`
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞

### ‚ùå –†–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ API –∏–ª–∏ CSRF —Ç–æ–∫–µ–Ω
**–†–µ—à–µ–Ω–∏–µ:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å `python test_mark_paid.py`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ

### ‚ùå React –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç markPaid
**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö –∏–ª–∏ –∫–æ–¥–µ
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ URL –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

## üß™ –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫–∞–∑
python check_order_status.py

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å webhook listener
stripe listen --forward-to localhost:8000/payment/webhook/

# 3. –û–ø–ª–∞—Ç–∏—Ç—å –∑–∞–∫–∞–∑ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook
# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ —Å–Ω–æ–≤–∞
python check_order_status.py
```

## üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:**
1. –õ–æ–≥–∏ Django –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ
2. –õ–æ–≥–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (F12 ‚Üí Console)
3. –†–µ–∑—É–ª—å—Ç–∞—Ç `python check_order_status.py`
4. –†–µ–∑—É–ª—å—Ç–∞—Ç `python test_mark_paid.py`
5. –í—ã–≤–æ–¥ `stripe listen`

## üéØ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç:** –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
‚úÖ **–†–µ–∑–µ—Ä–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç:** React API –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å
‚úÖ **–ó–∞–∫–∞–∑ –æ–ø–ª–∞—á–µ–Ω:** `paid=True` –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
